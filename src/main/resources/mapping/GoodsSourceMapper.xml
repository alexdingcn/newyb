<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yiban.erp.dao.GoodsSourceMapper" >
    <resultMap id="SellResultMap" type="com.yiban.erp.entities.GoodsSourceSell" >
        <result column="batch_code" property="batchCode" jdbcType="VARCHAR" />
        <result column="customer_name" property="customerName" jdbcType="VARCHAR" />
        <result column="ship_company_name" property="shipCompanyName" jdbcType="VARCHAR" />
        <result column="total_quantity" property="totalQuantity" jdbcType="DECIMAL" />
        <result column="total_amount" property="totalAmount" jdbcType="DECIMAL" />
        <result column="paid_amount" property="paidAmount" jdbcType="DECIMAL" />
        <result column="realname" property="realName" jdbcType="VARCHAR" />
    </resultMap>

    <resultMap id="BuyResultMap" type="com.yiban.erp.entities.GoodsSourceBuy" >
        <result column="batch_code" property="batchCode" jdbcType="VARCHAR" />
        <result column="buy_order_quality" property="buyOrderQuality" jdbcType="DECIMAL" />
        <result column="in_count" property="inCount" jdbcType="DECIMAL" />
        <result column="quantity" property="quantity" jdbcType="DECIMAL" />
        <result column="total_amount" property="totalAmount" jdbcType="DECIMAL" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="ship_name" property="shipName" jdbcType="VARCHAR" />
        <result column="realname" property="realName" jdbcType="VARCHAR" />
    </resultMap>

    <resultMap id="GoodResultMap" type="com.yiban.erp.entities.Goods" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="name" property="name" jdbcType="VARCHAR" />
    </resultMap>

    <sql id="Base_Column_List" >
    id, company_id, spec_no, spec_name, parent_id, parent_no, parent_name, created_by,
    updated_by, created_time, updated_time
  </sql>

    <select id="queryGoods" resultMap="GoodResultMap">
    select gi.id, gi.name
    from goods_info as gi
    where gi.company_id = #{companyId}
  </select>
    <select id="getBatch" resultType="String">
    select
    ri.batch_code
    from repertory_info as ri left join goods_detail as gd
                              on ri.goods_id = gd.id
                              left join goods_info as gi
                              on gd.goods_info_id = gi.id
    where gi.id = #{goodId,jdbcType=BIGINT}
  </select>

    <select id="getGoodIdByDetail" resultType="java.lang.Long">
    select
    goods_info_id
    from goods_detail
    where id = #{detailId,jdbcType=BIGINT}
  </select>

    <select id="countOnSell" resultType="Integer">
        select
        SUM(ri.on_way_quantity) AS TOTAL
        from repertory_info as ri left join goods_detail as gd
        on ri.goods_id = gd.id
        where  gd.goods_info_id = #{goodId}
        <if test =" batchCode != null  and batchCode != '' ">
            and ri.batch_code = #{batchCode}
        </if>
    </select>

    <select id="countStock" resultType="Integer">
        select sum(ri.quantity)
        from repertory_info as ri left join goods_detail as gd
        on ri.goods_id = gd.id
        where  gd.goods_info_id = #{goodId}
        <if test =" batchCode != null and batchCode != '' ">
            and ri.batch_code = #{batchCode}
        </if>
    </select>

    <select id="getSell" resultMap="SellResultMap">
        select
        sod.batch_code, cus.name as customer_name, sc.name as ship_company_name,so.total_quantity,so.total_amount,so.paid_amount,u.realname
        from sell_order as so
        left join sell_order_detail as sod
        on so.id = sod.sell_order_id
        left join customer as cus
        on so.customer_id = cus.id
        left join ship_company as sc
        on so.ship_company_id = sc.id
        left join users as u
        on so.sale_id = u.id
        where  sod.goods_id in(
        select gd.id from goods_detail as gd where gd.goods_info_id =  #{goodId}
        )
        <if test =" batchCode != null and batchCode != '' ">
            and sod.batch_code = #{batchCode}
        </if>
    </select>

    <select id="getBuy" resultType="java.lang.Long" resultMap="BuyResultMap">
        select
        rid.batch_code, rid.buy_order_quality, rid.in_count, rif.quantity, ri.total_amount, ri.create_time, sp.name as ship_name, bu.realname
        from repertory_in as ri
        left join repertory_in_detail as rid
        on ri.id = rid.in_order_id
        left join buy_order as bo
        on  ri.ref_order_id = bo.id
        left join supplier as sp
        on bo.supplier_id = sp.id
        left join repertory_info as rif
        on rid.goods_id = rif.goods_id and rid.batch_code = rif.batch_code and ri.id = rif.ref_order_id and rif.ref_type = 'BUY_ORDER'
        left join users as bu
        on ri.buyer_id = bu.id
        where  rid.goods_id in(
        select gd.id from goods_detail as gd where gd.goods_info_id =  #{goodId}
        )
        <if test =" batchCode != null and batchCode != '' ">
            and rid.batch_code = #{batchCode}
        </if>
    </select>
</mapper>